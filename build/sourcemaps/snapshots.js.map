{"version":3,"sources":["snapshots.js"],"names":[],"mappings":"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","file":"snapshots.js","sourcesContent":["var _ = require('lodash-node');\nvar fs = require('fs');\nvar gotPromise = require('got-promise');\nvar instapromise = require('instapromise');\nvar username = require('username');\n\nvar r = require('./database/r');\n\nfunction getExponentVersions(source) {\n  var jsObjString = source.match(/(\\$\\$\\$___EXPONENT_VERSIONS___\\$\\$\\$\\s*=\\s*({[^}]*}))/m)[2];\n  try {\n    return JSON.parse(jsObjString);\n  } catch (e) {\n    var err = new Error(\"Parsing EXPONENT_VERSIONS from bundle failed!: \" + e.message);\n    err.jsObjString = jsObjString;\n  }\n}\n\nasync function getExponentVersionsFromFileAsync(file) {\n  var source = await fs.promise.readFile(file, 'utf8');\n  return getExponentVersions(source);\n}\n\nasync function _loadSnapshotAsync(opts) {\n  opts = opts || {};\n  opts = _.assign({\n    host: 'localhost',\n    port: 8081,\n    dev: false,\n    minify: true,\n    protocol: 'http',\n    path: 'exponent.includeRequire.runModule.bundle',\n  }, opts);\n\n  var bundleUrl = opts.protocol + '://' + opts.host + ':' + opts.port + '/' + opts.path + '?dev=' + !!opts.dev + '&minify=' + !!opts.minify;\n\n  var response = await gotPromise.get(bundleUrl);\n  return response.body;\n}\n\nasync function getBrowserSnapshotAsync(opts) {\n  var bundle = await _loadSnapshotAsync(opts);\n  var versions = getExponentVersions(bundle);\n  return {\n    versions,\n    bundle,\n  };\n}\n\nasync function _saveBrowserSnapshotAsync(snapshot) {\n  var toInsert = _.clone(snapshot.versions);\n  toInsert.bundle = snapshot.bundle;\n  toInsert.snapshotTime = r.now();\n  var uploadingUsername = await username.promise();\n  toInsert.uploadedBy = uploadingUsername;\n  return await r.db('exp_host').table('browserSnapshots').insert(toInsert);\n}\n\nasync function takeBrowserSnapshotAsync(opts) {\n  var snapshot = await getBrowserSnapshotAsync(opts);\n  await _saveBrowserSnapshotAsync(snapshot);\n  return snapshot;\n}\n\nmodule.exports = {\n  getExponentVersions,\n  getExponentVersionsFromFileAsync,\n  getBrowserSnapshotAsync,\n  takeBrowserSnapshotAsync,\n  _saveBrowserSnapshotAsync,\n  _loadSnapshotAsync,\n};\n\nif (require.main === module) {\n  var opts = require('minimist')(process.argv.slice(2));\n  takeBrowserSnapshotAsync(opts).then((result) => {\n    if (result) {\n      result.bundle = result.bundle.substr(0, 50) + '...';\n      console.log(result);\n      process.exit(0);\n    }\n  }, (err) => {\n    console.error(err.stack || err);\n    process.exit(err.code || -1);\n  });\n}\n"],"sourceRoot":"/source/"}