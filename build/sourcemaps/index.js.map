{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["import child_process from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\n\nimport koa from 'koa';\nimport body from 'koa-body';\nimport conditional from 'koa-conditional-get';\nimport etag from 'koa-etag';\nimport gzip from 'koa-gzip';\nimport logger from 'koa-logger';\nimport rewrite from 'koa-rewrite';\nimport router from 'koa-router';\nimport serve from 'koa-static';\n\nimport api from './api/api';\nimport config from './config';\nimport servePackage from './servePackage';\n\nimport * as ServerSideRendering from './web/server/ServerSideRendering';\n\nlet app = koa();\napp.name = 'exp-host';\napp.proxy = true;\napp.experimental = true;\n\napp.use(logger());\napp.use(gzip());\n\nlet endpointRouter = router({ prefix: '/--' });\nendpointRouter.use(body());\n\nendpointRouter.all('/api/:method/:jsonArgs', api.callMethod);\nendpointRouter.get('/appetize', function*(next) {\n  this.type = 'text/html';\n  this.body = yield fs.promise.readFile(path.join(__dirname, '../appetize.html'), 'utf8');\n});\nendpointRouter.get('/feedback', require('./feedbackSubmit'));\nendpointRouter.post('/feedback/submit', require('./feedbackSubmit'));\nendpointRouter.get('/git-hash', function*(next) {\n  this.type = 'text/plain';\n  this.body = yield child_process.promise.exec('git rev-parse HEAD');\n});\nendpointRouter.get('/to-exp/:url', function*(next) {\n  this.status = 301;\n  this.response.redirect(this.params.url);\n  //this.body = \"<script>window.location=\" + JSON.stringify(this.params.url) + \";</script>\";\n\n  // TODO: Since Safari will pop up an alert asking the user to confirm the redirect,\n  // we may want to show some web content that hints at what will happen (or maybe not?)\n});\n\napp.use(endpointRouter.routes());\napp.use(endpointRouter.allowedMethods());\n\n// TODO: Write middleware for the bundle router so it always responds in a way\n// that RN handles well\nlet bundleRouter = router();\nbundleRouter.get('/@:username/:package?', servePackage);\nbundleRouter.get('/app/exponent', require('./browser').serveBrowserBundleAsync);\nbundleRouter.get('/exponent', function*(next) {\n  require('instapromise');\n  let sourcePath;\n  if (this.query.version === '2015-05-25') {\n    sourcePath = '../home-2015-05-25.bundle.js';\n  } else {\n    sourcePath = '../home.bundle.js';\n  }\n  let source = yield fs.promise.readFile(path.join(__dirname, sourcePath), 'utf8');\n  this.type = 'application/javascript';\n  this.body = source;\n});\nbundleRouter.get('/rnplay/', require('./rnplay').form);\nbundleRouter.get('/rnplay/:shortCode', require('./rnplay').route);\napp.use(bundleRouter.routes());\napp.use(bundleRouter.allowedMethods());\n\nlet siteRouter = router();\nsiteRouter.use(conditional());\nsiteRouter.use(etag());\n\nsiteRouter.get('/\\\\.:shortcode', function*(next) {\n  let shortUrl = require('./shortUrl');\n  let { shortcode } = this.params;\n  let url = yield shortUrl.urlForCodeAsync(shortcode);\n  console.log('Short URL for code', shortcode, 'points to URL', url);\n  if (url) {\n    // TODO: Switch this from a proxy to a redirect once the client\n    // can handle redirects\n    var body = yield shortUrl.urlProxyBodyAsync(url);\n    this.type = 'application/javascript';\n    this.body = body;\n    //this.response.redirect(url);\n  } else {\n    this.throw(404, 'No such short URL: .' + shortcode);\n  }\n  this.type = 'text/html';\n  this.body = 'Short URL for code ' + shortcode;\n});\nsiteRouter.get('/images/(.*)',\n  rewrite('/images/*', '$1'),\n  serve('src/web/images'),\n);\nsiteRouter.get('/assets/(.*)',\n  rewrite('/assets/*', '$1'),\n  serve('build/web/assets'),\n);\nsiteRouter.get('/(.*)', function*(next) {\n  let reactMarkup = yield ServerSideRendering.renderPageAsync(this.url);\n  this.body = reactMarkup;\n  this.type = 'text/html';\n});\napp.use(siteRouter.routes());\napp.use(siteRouter.allowedMethods());\n\nif (require.main === module) {\n  let { port } = config.server;\n  let server = app.listen(port, () => {\n    let addr = server.address();\n    let port = addr.port;\n    let host = addr.address;\n    console.log('Listening on http://' + host + ':' + port + ' using NODE_ENV=' + process.env.NODE_ENV);\n  });\n}\n\nexport { app };\n\n/*\nbuild and serve static assets. want to support both development and production mode.\n\nbabel: build api server\nwebpack: build static assets with __DEV__ settable. maybe have output go to build/web/__DEV__?\nkoa: run koa server with NODE_ENV settable\nconfig options:\n  process.env.NODE_ENV\n  __DEV__\n\n\n\n\nuse react hot loader / webpack dev server to serve static assets. support development and production mode.\n\nbabel: just use babel-node with koa's NODE_ENV settable\nwebpack: run webpack dev server with __DEV__ settable\n\n*/\n"],"sourceRoot":"/source/"}