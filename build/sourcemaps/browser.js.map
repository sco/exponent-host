{"version":3,"sources":["browser.js"],"names":[],"mappings":"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","file":"browser.js","sourcesContent":["require('instapromise');\n\nconst fs = require('fs');\nconst path = require('path');\nconst request = require('request');\n\nconst AwaitLock = require('await-lock');\n\nconst r = require('./database/r');\n\nconst BROWSER_BUNDLE_URLS = {\n  1: 'http://localhost:8081/exponent.includeRequire.runModule.bundle?dev=false&minify=true',\n};\n\nconst BROWSER_BUNDLE_FILES = {\n  '1:': 'exponent-2015-05-25.bundle.js',\n  '1:e8791bd94f1f2052572e755b8d7b29f29a6d99f3': 'exponent.bundle.js',\n  1: 'exponent.bundle.js',\n};\n\nvar bundleCache = {};\nvar bundleDownloadLocks = {};\n\nexport function* serveBrowserBundleAsync() {\n  let version = this.query.version || '1';\n  let reactNativeCommit = this.query.reactNativeGitHash;\n  this.body = yield loadBundleAsync(version, reactNativeCommit);\n  this.type = 'application/javascript';\n}\n\nexport async function fetchBrowserBundleAsync(opts) {\n  opts = opts || {};\n  let f = {};\n  for (let key of [\n    'exponentVersion',\n    'exponentGitHash',\n    'reactNativeVersion',\n    'reactNativeGitHash',\n    'dev',\n    'minify',\n    'key',\n  ]) {\n    if (opts.hasOwnProperty(key)) {\n      var val = opts[key];\n      if (val === 'true') {\n        val = true;\n      }\n      if (val === 'false') {\n        val = false;\n      }\n      f[key] = val;\n    }\n  }\n  let result = await r\n    .db('exp_host')\n    .table('browserBundles')\n    .filter(f, {default: true})\n    .orderBy(\n      r.desc('minify'),\n      r.asc('dev'),\n      r.desc('reactNativeVersion'),\n      r.desc('exponentVersion'),\n      r.desc('uploadTime')\n    )\n    .limit(1)\n    ;\n\n  return result[0] || null;\n\n}\n\nexport function* serveBrowserBundleFromDatabaseAsync() {\n  let bundle = yield fetchBrowserBundleAsync(this.query);\n  if (bundle) {\n    this.body = bundle.bundle;\n    this.type = 'application/javascript';\n  } else {\n    this.type = 'text/plain';\n    this.throw(404, \"No bundle matching your query's description is available\");\n  }\n}\n\n\nasync function loadBundleAsync(version, reactNativeCommit) {\n  if (process.env.NODE_ENV === 'production') {\n    version += ':' + (reactNativeCommit || '');\n  }\n\n  if (bundleCache[version]) {\n    return bundleCache[version];\n  }\n\n  if (process.env.NODE_ENV === 'production') {\n    if (!BROWSER_BUNDLE_FILES[version]) {\n      let numericVersion = /(\\d+):/.exec(version)[1];\n      let bundleFile = path.join(__dirname, '..', BROWSER_BUNDLE_FILES[numericVersion]);\n      return fs.promise.readFile(bundleFile, 'utf8');\n    }\n\n    let bundleFile = path.join(__dirname, '..', BROWSER_BUNDLE_FILES[version]);\n    let bundle = await fs.promise.readFile(bundleFile, 'utf8');\n    bundleCache[version] = bundle;\n    return bundleCache[version];\n  }\n\n  let bundleUrl = BROWSER_BUNDLE_URLS[version];\n  if (!bundleUrl) {\n    throw new Error(`No app bundle URL for version ${version}`);\n  }\n\n  if (!bundleDownloadLocks[version]) {\n    bundleDownloadLocks[version] = new AwaitLock();\n  }\n\n  var lock = bundleDownloadLocks[version];\n  await lock.acquireAsync();\n\n  try {\n    if (bundleCache[version]) {\n      return bundleCache[version];\n    }\n\n    let response = await request.promise(bundleUrl);\n    if (response.statusCode === 200) {\n      bundleCache[version] = response.body;\n    }\n    return bundleCache[version];\n  } finally {\n    lock.release();\n  }\n}\n"],"sourceRoot":"/source/"}